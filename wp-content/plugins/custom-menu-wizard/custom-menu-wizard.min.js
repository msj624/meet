/* Plugin Name: Custom Menu Wizard
 * Version: 2.0.2
 * Author: Roger Barrett
 * 
 * Script for controlling this widget's options (in Admin -> Widgets)
*/
jQuery(function(f){var n={getDialog:function(c){return f("#"+c.find(".widget-custom-menu-wizard-onchange").data().cmwDialogId)},getSettings:function(c){var a={};f.each(c.serializeArray(),function(d,c){var b=c.name.replace(/.*\[([^\]]+)\]$/,"$1"),e="items"!==b&&/^-?\d+$/.test(c.value)?parseInt(c.value,10):c.value;a[b]=e;"items"===b&&(a._items_sep=!e||/(^\d+$|,)/.test(f.trim(e))?",":" ",e=f.map(e.split(/[,\s]+/),function(a){a=a?parseInt(a,10):0;return isNaN(a)||1>a?null:a}),a._items=e.join(a._items_sep))});
return a},buildRecurse:function(c,a,d){var f="",b,e;a=(a||0)+1;d=d||"";for(b in c)e=b.split("|")[0],f+='<li class="level-'+a+'" data-itemid="'+e+'" data-level="'+a+'" data-trace="'+d+'">',f+='<a class="ui-corner-all" href="#"><span class="ui-corner-all" title="#'+e+'">'+b.replace(/^\d+\|/,""),f+='</span></a><input type="checkbox" value="'+e+'" />',c[b]&&(f+="<ul>"+n.buildRecurse(c[b],a,e+(d?",":"")+d)+"</ul>"),f+="</li>";return f},changeMenu:function(c){c=f(this);var a=f(c.closest(".ui-dialog-content").data().cmwTriggerChange).closest("form").find(".widget-custom-menu-wizard-setitems"),
d=f.trim(a.val()),d=!d||/(^\d+$|,)/.test(d)?",":" ";a.val(c.closest(".cmw-demo-themenu").find("input").map(function(){return this.checked?this.value:null}).get().join(d)).trigger("change")},clickMenu:function(c){var a=f(this);c=["current-menu-item","current-menu-parent","current-menu-ancestor"];var d=a.closest(".ui-dialog-content"),h=d.find(".cmw-demo-themenu"),a=a.find("span").not("."+c[0]).parentsUntil(h,"li"),b,e=function(){this.title=this.title+" "+b.replace(" "," & ").replace(/-/g," ")};h.find("."+
c.join(",.")).removeClass(c.join(" ")).each(function(){this.title=this.title.replace(/\s.*$/,"")});for(h=0;h<a.length;h++)b=1===h?c.join(" "):c[0],a.eq(h).children("a").find("span").addClass(b).each(e),1<c.length&&c.shift();f(d.data().cmwTriggerChange).trigger("change");return!1},clickOutput:function(c){c=this.href.split("#")[1];f(this).closest(".ui-dialog-content").find(".cmw-demo-themenu a").eq(c).not(":has(.current-menu-item)").trigger("click");this.blur();return!1},createMenu:function(c,a){var d=
c.data(),h=c.find(".cmw-demo-themenu"),b=a.find(".widget-custom-menu-wizard-selectmenu"),e=parseInt(b.val(),10),m=h.find("ul").eq(0),k=h.data(),g;m.length&&m.data("menuid")===e||(g=f("<ul>"+n.buildRecurse(a.find(".widget-custom-menu-wizard-childrenof optgroup").data().cmwItems||{})+"</ul>"),m.remove(),c.dialog("option","title",d.cmwTitlePrefix+b.find("option:selected").text()),k.maxLevel=0,h.append(g.data("menuid",e)).find("a").each(function(a){var b=f(this).parent("li").data().level;f(this).data("indx",
a);b&&b>k.maxLevel&&(k.maxLevel=b)}))},init:function(c){var a=f(this);c=a.closest(".widget-custom-menu-wizard-onchange").data();var d=f("#"+c.cmwDialogId),a=a.closest("form");d.length||(d=f("<div/>",{id:c.cmwDialogId}).addClass("widget-custom-menu-wizard-dialog").data({cmwTriggerChange:c.cmwDialogTrigger,cmwTitlePrefix:c.cmwDialogTitle}).append(f("<div/>").addClass("cmw-demo-theoutput").html("<strong>"+c.cmwDialogOutput+'</strong> &hellip;<div class="cmw-demo-theoutput-wrap ui-corner-all"></div><div class="cmw-demo-fallback"><small>'+
c.cmwDialogFallback+"</small></div>")).append(f("<div/>").addClass("cmw-demo-themenu").html("<small><em>"+c.cmwDialogPrompt+"</em></small>")).append(f("<div/>").addClass("cmw-demo-theshortcode").html('<code class="ui-corner-all">[custom_menu_wizard]</code>')),d.find(".cmw-demo-themenu").on("click","a",n.clickMenu),d.find(".cmw-demo-themenu").on("change","input",n.changeMenu),d.find(".cmw-demo-theoutput").on("click","a",n.clickOutput),d.dialog({autoOpen:!1,width:Math.min(0.8*f(window).width(),600),
modal:!1}));d.dialog("isOpen")?d.dialog("close"):(n.createMenu(d,a),d.dialog("open"),f(c.cmwDialogTrigger).trigger("change"));this.blur();return!1},shortcode:function(c,a){var d={menu:[a.menu]},h,b,e;a.title&&(d.title=a.title);if(0<a.filter)switch(a.filter_item){case 0:d.children_of="current";break;case -1:d.children_of="parent";break;case -2:d.children_of="root";break;default:d.children_of=[a.filter_item]}0>a.filter&&(d.items=a._items);0<a.filter&&0>a.filter_item&&a.fallback_no_ancestor&&(d.fallback_parent=
a.fallback_include_parent_siblings?"siblings":a.fallback_include_parent?"parent":[1]);0<a.filter&&!a.filter_item&&a.fallback_no_children&&(d.fallback_current=a.fallback_nc_include_parent_siblings?"siblings":a.fallback_nc_include_parent?"parent":[1]);1<a.start_level&&(d.start_level=[a.start_level]);0<a.depth&&(d.depth=[a.depth]);a.depth_rel_current&&0<a.depth&&(d.depth_rel_current=[1]);e=[];0<a.filter&&(a.include_parent_siblings?e.push("siblings"):a.include_parent&&e.push("parent"),a.include_ancestors&&
e.push("ancestors"),e.length&&(d.include=e.join(" ")));e=[];0<a.filter&&a.title_from_parent&&e.push("parent");a.title_from_current&&e.push("current");e.length&&(d.title_from=e.join(" "));for(e in{flat_output:1,contains_current:1,ol_root:1,ol_sub:1})a[e]&&(d[e]=[1]);h={container:"div",container_id:"",container_class:"",menu_class:"menu-widget",widget_class:""};for(e in h)a[e]!==h[e]&&(d[e]=a[e]);h={wrap_link:"before",wrap_link_text:"link_before"};for(e in h)(b=a[h[e]].toString().match(/^<(\w+)/))&&
b[1]&&(d[e]=b[1]);h=[];for(e in d)h.push(f.isArray(d[e])?e+"="+d[e][0]:e+'="'+d[e]+'"');n.getDialog(c).find("code").text("[custom_menu_wizard "+h.join(" ")+"]")},show:function(c,a,d){a=a||f(this).closest("form");d=d||n.getSettings(a);c=n.getDialog(a);var h=c.find(".cmw-demo-themenu"),b=h.find(".picked"),e="",m="",k=0,g=c.find(".cmw-demo-theoutput-wrap").empty(),p=["menu-widget"],q={};if(b.length&&g.length){0<d.filter&&d.title_from_parent&&(m=h.find(".the-parent").children("a").text()||"");!m&&d.title_from_current&&
(m=h.find(".current-menu-item").text()||"");m||d.hide_title||(m=d.title||"");for(b.each(function(a){var b=f(this),c=b.data(),h=c.trace?c.trace.toString().split(","):[];a=c.itemid.toString();var g=1,b=b.children("a");if(!d.flat_output)for(q[a]=1,a=0;a<h.length;a++)q[h[a]]&&g++;if(k)if(g>k)e+=d.ol_sub?"<ol>":"<ul>";else{for(;k>g;)--k,e+="</li>"+(d.ol_sub?"</ol>":"</ul>");e+="</li>"}e+='<li class="cmw-level-'+g+(c.included||"")+'"><a href="#'+b.data("indx")+'">'+b.text()+"</a>";k=g});1<k;)--k,e+="</li>"+
(d.ol_sub?"</ol>":"</ul>");e+="</li>";p.push(c.find(".cmw-demo-fallback").data("fellback"));e=(d.ol_root?"<ol":"<ul")+' class="'+f.trim(p.join(" "))+'">'+e+(d.ol_root?"</ol>":"</ul>");g.html(e);m&&g.prepend("<h3>"+m+"</h3>");g.find("li").filter(function(){return!!f(this).children("ul, ol").length}).addClass("cmw-has-submenu")}n.shortcode(a,d)},update:function(c){var a=f(this).closest("form"),d=n.getDialog(a),h,b,e,m,k,g,p,q,r,l,s;if(d.length&&d.dialog("isOpen")){f(c.target).hasClass("widget-custom-menu-wizard-selectmenu")&&
n.createMenu(d,a);b=n.getSettings(a);e=b.include_parent;m=b.include_parent_siblings;k=d.find(".cmw-demo-themenu");h=k.data().maxLevel;p=k.find(".current-menu-item").closest("li");q=p.length?p.data().level:-1;g=k.find("li").removeData("included").removeClass("the-parent");0>b.filter&&(g=g.filter(function(){var a=f(this).children("input"),c=-1<(b._items_sep+b._items+b._items_sep).indexOf(b._items_sep+a[0].value+b._items_sep);a.prop("checked",c);return c}),b._items||(g=f([])));g.length&&!p.length&&(b.contains_current||
0<b.filter&&1>b.filter_item)&&(g=f([]));g.length&&0<b.filter&&(0<b.filter_item?l=g.filter("[data-itemid="+b.filter_item+"]"):b.filter_item?1===q&&b.fallback_no_ancestor?(l=p,e=e||b.fallback_include_parent,m=m||b.fallback_include_parent_siblings,r="cmw-fellback-to-current"):l=1===q?k:-1>b.filter_item?k.find(".current-menu-ancestor").eq(0).closest("li"):k.find(".current-menu-parent").closest("li"):p.find("li").length?l=p:b.fallback_no_children&&(l=k.find(".current-menu-parent").closest("li"),l.length||
(l=k),e=e||b.fallback_nc_include_parent,m=m||b.fallback_nc_include_parent_siblings,r="cmw-fellback-to-parent"));if(g.length)if(b.filter)l&&l.length?(s=b.depth_rel_current&&b.depth&&p.length&&l.has(p[0]).length?q-1+b.depth:b.depth?Math.max((l.data().level||0)+b.depth,b.start_level+b.depth-1):9999,g=l.find("li").filter(function(){var a=f(this).data().level;return a>=b.start_level&&a<=s})):0<b.filter&&(g=f([]));else for(s=b.depth_rel_current&&b.depth&&p.length&&q>=b.start_level?q+b.depth-1:b.depth?b.start_level+
b.depth-1:9999,q=1;q<=h;q++)if(q<b.start_level||q>s)g=g.not(".level-"+q);g.length&&0<b.filter&&l&&l.is("li")&&(m&&(g=g.add(l.siblings("li").data("included"," cmw-an-included-parent-sibling")),e=!0),b.include_ancestors&&(g=g.add(l.parentsUntil(k,"li").data("included"," cmw-an-included-ancestor")),e=!0),e&&(g=g.add(l.data("included"," cmw-the-included-parent"))));!g.length||!b.contains_current||p.length&&g.filter(p).length||(g=f([]));g.length&&l&&l.is("li")&&l.addClass("the-parent");r=g.length?r:"";
d.find(".cmw-demo-fallback").data("fellback",r).toggleClass("cmw-demo-fellback",!!r);k.toggleClass("cmw-demo-filteritems",0>b.filter).find(".picked").not(g.addClass("picked")).removeClass("picked");n.show.call(this,c,a,b)}}};f(document).on("click",".widget-custom-menu-wizard-collapsible-fieldset",function(){var c=f(this),a=c.find("input").eq(0),d=!a.prop("checked");a.length&&(a.prop("checked",d),c.find("div").toggleClass("cmw-collapsed-fieldset",d),c.next("div")[d?"slideUp":"slideDown"]());this.blur();
return!1}).on("change",".widget-custom-menu-wizard-listen",function(){var c=f(this.form),a=c.find(".widget-custom-menu-wizard-selectmenu"),d=c.find(".widget-custom-menu-wizard-showall").prop("checked"),h=c.find(".widget-custom-menu-wizard-showspecific").prop("checked"),c=c.find(".widget-custom-menu-wizard-childrenof"),b=parseInt(c.val(),10),e;a.is(this)&&(a=this.selectedIndex,c.find("optgroup").filter(function(){var b=f(this).data("cmwOptgroupIndex")===a;b||f(this).remove();return b}).length||(e=
f("#"+c.attr("id")+"_ignore").find("optgroup").eq(a).clone(),e.length&&(0<b&&(b=0,c.val(b)),e.find("option[selected]").removeAttr("selected").prop("selected",!1),c.append(e))));f.each({"":d||h,"-ss":h,"not-rp":d||h||0<=b,"not-ci":d||h||!!b},function(a,b){f(".widget-custom-menu-wizard-disableif"+a,this.form).toggleClass("cmw-colour-grey",b).find("input,select").prop("disabled",b)})}).on("change",".widget-custom-menu-wizard-onchange",n.update).on("click",".widget-custom-menu-wizard-toggle-assist",n.init).on("click",
".widget-action, .widget-control-close",function(){f(this).closest("div.widget").find(".widget-custom-menu-wizard-onchange").each(function(){var c=f("#"+f(this).data().cmwDialogId);c.length&&c.dialog("isOpen")&&c.dialog("close")})});window.wpWidgets?(window.wpWidgets.fixLabels&&!window.wpWidgets._cmw_fixLabels&&(window.wpWidgets._cmw_fixLabels=window.wpWidgets.fixLabels,window.wpWidgets.fixLabels=function(c){c.find(".widget-custom-menu-wizard-selectmenu").trigger("change");window.wpWidgets._cmw_fixLabels(c)}),
window.wpWidgets.save&&!window.wpWidgets._cmw_save&&(window.wpWidgets._cmw_save=window.wpWidgets.save,window.wpWidgets.save=function(c,a,d,h){a&&c.find(".widget-custom-menu-wizard-onchange").each(function(){var a=f("#"+f(this).data().cmwDialogId);a.length&&(a.dialog("destroy"),a.remove())});window.wpWidgets._cmw_save(c,a,d,h)})):f(".widget-custom-menu-wizard-selectmenu").trigger("change")});